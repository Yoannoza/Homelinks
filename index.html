<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelinks - Votre Maison Connect√©e</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <input type="checkbox" id="theme-switch" class="theme-switch-input">
        <label for="theme-switch" class="theme-switch-label">
            <i class="fas fa-sun"></i>
            <i class="fas fa-moon"></i>
        </label>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Header -->
        <header class="header-section">
            <div class="welcome-card glass-card">
                <div class="welcome-content">
                    <h1 class="welcome-title">
                        <i class="fas fa-home"></i>
                        Bonjour !
                    </h1>
                    <p class="welcome-subtitle">Homelinks - Votre Maison Connect√©e</p>
                    <div class="status-indicators">
                        <span class="status-dot active"></span>
                        <span class="status-text">Syst√®me actif</span>
                        <div class="api-status" id="api-status">
                            <i class="fas fa-brain"></i>
                            <span class="api-status-text">Connexion IA...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Lighting Control Section -->
                <section class="control-section">
                    <div class="section-header">
                        <i class="fas fa-lightbulb"></i>
                        <h2>√âclairage</h2>
                    </div>
                    <div class="lights-grid">
                        <div class="light-card glass-card" data-room="salon">
                            <div class="light-icon">
                                <i class="fas fa-couch"></i>
                            </div>
                            <h3>Salon</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="salon" onchange="switchLED(this)">
                                <label for="salon" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="cuisine">
                            <div class="light-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <h3>Cuisine</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="cuisine" onchange="switchLED(this)">
                                <label for="cuisine" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="chambre">
                            <div class="light-icon">
                                <i class="fas fa-bed"></i>
                            </div>
                            <h3>Chambre</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="chambre" onchange="switchLED(this)">
                                <label for="chambre" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="exterieur">
                            <div class="light-icon">
                                <i class="fas fa-tree"></i>
                            </div>
                            <h3>Ext√©rieur</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="exterieur" onchange="switchLED(this)">
                                <label for="exterieur" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="garage">
                            <div class="light-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <h3>Garage</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="garage" onchange="switchLED(this)">
                                <label for="garage" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Sensors Section -->
                <section class="control-section">
                    <div class="section-header">
                        <i class="fas fa-shield-alt"></i>
                        <h2>D√©tecteurs Sensoriels</h2>
                    </div>
                    <div class="sensors-grid">
                        <div class="sensor-card glass-card">
                            <div class="sensor-indicator">
                                <input type="checkbox" id="presence" class="sensor-input">
                                <label for="presence" class="sensor-label">
                                    <i class="fas fa-walking"></i>
                                </label>
                            </div>
                            <h3>D√©tecteur de Pr√©sence</h3>
                            <span class="sensor-status">Inactif</span>
                        </div>

                        <div class="sensor-card glass-card">
                            <div class="sensor-indicator">
                                <input type="checkbox" id="smoke" class="sensor-input">
                                <label for="smoke" class="sensor-label">
                                    <i class="fas fa-fire-smoke"></i>
                                </label>
                            </div>
                            <h3>D√©tecteur de Fum√©e</h3>
                            <span class="sensor-status">S√©curis√©</span>
                        </div>

                        <div class="sensor-card glass-card">
                            <div class="sensor-indicator">
                                <input type="checkbox" id="auth" class="sensor-input">
                                <label for="auth" class="sensor-label">
                                    <i class="fas fa-id-card"></i>
                                </label>
                            </div>
                            <h3>Authentification RFID</h3>
                            <span class="sensor-status">En attente</span>
                        </div>
                    </div>
                </section>

                <!-- Alarm Section -->
                <section class="control-section alarm-section">
                    <div class="section-header">
                        <i class="fas fa-alarm-clock"></i>
                        <h2>R√©veil Intelligent</h2>
                    </div>
                    <div class="alarm-card glass-card">
                        <form id="alarmForm" class="alarm-form">
                            <div class="time-input-container">
                                <input type="time" id="alarmTime" class="alarm-time-input" value="10:05" required>
                                <label for="alarmTime" class="time-label">Heure du r√©veil</label>
                            </div>
                            <button type="submit" class="alarm-btn">
                                <i class="fas fa-clock"></i>
                                Programmer
                            </button>
                            <p id="status" class="alarm-status"></p>
                        </form>
                    </div>
                </section>
            </div>
            <!-- Right Column -->
            <div class="right-column">
                <!-- Clock and Date Widget -->
                <section class="widget-section">
                    <div class="datetime-widget glass-card">
                        <div class="clock-container">
                            <div class="analog-clock">
                                <div class="clock-face">
                                    <div class="hour-hand" id="hr"></div>
                                    <div class="minute-hand" id="mn"></div>
                                    <div class="second-hand" id="sc"></div>
                                    <div class="center-dot"></div>
                                </div>
                            </div>
                            <div class="digital-time">
                                <div class="time-display" id="digital-time"></div>
                                <div class="date-display" id="date-display">
                                    <span id="day">day</span>,
                                    <span id="daynum">00</span>
                                    <span id="month">month</span>
                                    <span id="year">0000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Climate Control -->
                <section class="widget-section">
                    <div class="section-header">
                        <i class="fas fa-thermometer-half"></i>
                        <h2>Climat</h2>
                    </div>
                    <div class="climate-grid">
                        <div class="climate-card glass-card">
                            <div class="gauge-header">
                                <i class="fas fa-temperature-high"></i>
                                <h3>Temp√©rature</h3>
                            </div>
                            <div id="gauge_temp" class="gauge-container modern-gauge"></div>
                        </div>
                        <div class="climate-card glass-card">
                            <div class="gauge-header">
                                <i class="fas fa-tint"></i>
                                <h3>Humidit√©</h3>
                            </div>
                            <div id="gauge_hum" class="gauge-container modern-gauge"></div>
                        </div>
                    </div>
                </section>

                <!-- Security Section -->
                <section class="widget-section">
                    <div class="section-header">
                        <i class="fas fa-lock"></i>
                        <h2>S√©curit√©</h2>
                    </div>
                    <div class="security-grid">
                        <div class="door-card glass-card">
                            <div class="door-control" id="d1" onclick="toggleDoors1()">
                                <div class="door-wrapper">
                                    <img src="https://images.pexels.com/photos/276724/pexels-photo-276724.jpeg?cs=srgb&dl=pexels-pixabay-276724.jpg&fm=jpg" alt="Entr√©e" class="door-image">
                                    <div id="left-door1" class="door-panel left">
                                        <div class="door-handle"></div>
                                    </div>
                                    <div id="right-door1" class="door-panel right">
                                        <div class="door-handle"></div>
                                    </div>
                                </div>
                            </div>
                            <h3>Entr√©e Principale</h3>
                            <span class="door-status" id="door1-status">Ferm√©e</span>
                        </div>

                        <div class="door-card glass-card">
                            <div class="door-control" id="d2" onclick="toggleDoors2()">
                                <div class="door-wrapper">
                                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS-gHRKbPfAPUlJjXVoO5kZOD0PCVhfWqv0Zg&s" alt="Garage" class="door-image">
                                    <div id="left-door2" class="door-panel left">
                                        <div class="door-handle"></div>
                                    </div>
                                    <div id="right-door2" class="door-panel right">
                                        <div class="door-handle"></div>
                                    </div>
                                </div>
                            </div>
                            <h3>Garage</h3>
                            <span class="door-status" id="door2-status">Ferm√©e</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Voice Control Button -->
        <div class="voice-control">
            <button id="record-button" class="voice-btn">
                <div class="voice-icon">
                    <i class="fas fa-microphone"></i>
                </div>
                <div class="voice-waves">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            <span class="voice-hint">Appuyez et maintenez pour parler</span>
        </div>

        <!-- Loading Animation -->
        <div class="loading-overlay" id="overlay">
            <div class="loading-spinner" id="loader">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <p>Traitement en cours...</p>
            </div>
        </div>
    </div>
    
    <p id="transcript" style="display: none;"></p>
    <script type="text/javascript" src="js/gauge.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // üîó WebSocket Connection for Real-time Updates
        const socket = io('http://127.0.0.1:5000');
        
        socket.on('connect', () => {
            console.log('üîó Connected to Homelinks AI Server');
            // Update status indicator
            const statusText = document.querySelector('.status-text');
            const apiStatus = document.getElementById('api-status');
            const apiStatusText = document.querySelector('.api-status-text');
            
            if (statusText) {
                statusText.textContent = 'SYST√àME CONNECT√â';
                statusText.style.color = 'var(--neon-lime)';
            }
            
            if (apiStatus && apiStatusText) {
                apiStatus.className = 'api-status connected';
                apiStatusText.textContent = 'IA Connect√©e';
            }
        });
        
        socket.on('audio_ready', (data) => {
            console.log('üéµ Audio response ready:', data.url);
            // Auto-play r√©ponse audio via WebSocket
            fetch(`http://127.0.0.1:5000${data.url}`)
                .then(response => response.blob())
                .then(audioBlob => {
                    const audio = new Audio(URL.createObjectURL(audioBlob));
                    audio.play();
                })
                .catch(err => {
                    console.log('Fallback to direct audio URL');
                    const audio = new Audio(`http://127.0.0.1:5000/audio`);
                    audio.play();
                });
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from AI Server');
            const statusText = document.querySelector('.status-text');
            const apiStatus = document.getElementById('api-status');
            const apiStatusText = document.querySelector('.api-status-text');
            
            if (statusText) {
                statusText.textContent = 'CONNEXION PERDUE';
                statusText.style.color = 'var(--neon-orange)';
            }
            
            if (apiStatus && apiStatusText) {
                apiStatus.className = 'api-status error';
                apiStatusText.textContent = 'IA D√©connect√©e';
            }
        });

        // üöÄ Revolutionary Theme System
        const themeToggle = document.getElementById('theme-switch');
        const body = document.body;

        themeToggle.addEventListener('change', () => {
            body.classList.toggle('light-theme');
            localStorage.setItem('theme', body.classList.contains('light-theme') ? 'light' : 'dark');
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            body.classList.add('light-theme');
            themeToggle.checked = true;
        }

        // Digital Time Display
        function updateDigitalTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('digital-time').textContent = timeString;
        }

        // Analog Clock
        function updateAnalogClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const hourDeg = (hours % 12) * 30 + minutes * 0.5;
            const minuteDeg = minutes * 6;
            const secondDeg = seconds * 6;

            document.getElementById('hr').style.transform = `rotate(${hourDeg}deg)`;
            document.getElementById('mn').style.transform = `rotate(${minuteDeg}deg)`;
            document.getElementById('sc').style.transform = `rotate(${secondDeg}deg)`;
        }

        // Update time displays
        function updateTime() {
            updateDigitalTime();
            updateAnalogClock();
        }

        setInterval(updateTime, 1000);
        updateTime(); // Initial call

        // Date Display
        function updateDate() {
            const today = new Date();
            const dayName = today.getDay();
            const dayNum = today.getDate();
            const month = today.getMonth();
            const year = today.getFullYear();

            const months = [
                "Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
                "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"
            ];
            const dayWeek = [
                "Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"
            ];

            document.getElementById('day').textContent = dayWeek[dayName];
            document.getElementById('daynum').textContent = dayNum.toString().padStart(2, '0');
            document.getElementById('month').textContent = months[month];
            document.getElementById('year').textContent = year;
        }

        updateDate();

        // Enhanced Door Controls
        function toggleDoors1() {
            const door = document.getElementById('d1');
            const status = document.getElementById('door1-status');
            door.classList.toggle('open');
            status.textContent = door.classList.contains('open') ? 'Ouverte' : 'Ferm√©e';
            status.className = door.classList.contains('open') ? 'door-status open' : 'door-status';
        }

        function toggleDoors2() {
            const door = document.getElementById('d2');
            const status = document.getElementById('door2-status');
            door.classList.toggle('open');
            status.textContent = door.classList.contains('open') ? 'Ouverte' : 'Ferm√©e';
            status.className = door.classList.contains('open') ? 'door-status open' : 'door-status';
        }

        // Enhanced Switch LED function
        function switchLED(checkbox) {
            const card = checkbox.closest('.light-card');
            const room = card.dataset.room;
            
            if (checkbox.checked) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }

            // Call your existing API
            var state = checkbox.checked ? 'on' : 'off';
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(`${room} light ${state}`);
                }
            };
            xhttp.open("GET", "http://34.134.18.88:5000/" + checkbox.id + "/" + state, true);
            xhttp.send();
        }

        // Enhanced Sensor Status Updates
        function updateSensorStatus(sensorId, active) {
            const sensorCard = document.querySelector(`#${sensorId}`).closest('.sensor-card');
            const statusText = sensorCard.querySelector('.sensor-status');
            
            if (active) {
                sensorCard.classList.add('active');
                document.getElementById(sensorId).checked = true;
                
                switch(sensorId) {
                    case 'presence':
                        statusText.textContent = 'Pr√©sence d√©tect√©e';
                        break;
                    case 'smoke':
                        statusText.textContent = 'Fum√©e d√©tect√©e';
                        break;
                    case 'auth':
                        statusText.textContent = 'Authentifi√©';
                        break;
                }
            } else {
                sensorCard.classList.remove('active');
                document.getElementById(sensorId).checked = false;
                
                switch(sensorId) {
                    case 'presence':
                        statusText.textContent = 'Inactif';
                        break;
                    case 'smoke':
                        statusText.textContent = 'S√©curis√©';
                        break;
                    case 'auth':
                        statusText.textContent = 'En attente';
                        break;
                }
            }
        }

        // Initialize gauges
        var gauge_temp = Gauge(
            document.getElementById("gauge_temp"), {
                label: function(value) {
                    return value + "¬∞C";
                },
                max: 100,
                value: 0,
            }
        );

        var gauge_hum = Gauge(
            document.getElementById("gauge_hum"), {
                label: function(value) {
                    return value + "%";
                },
                max: 100,
                value: 0
            }
        );

        let temp = "";
        let hum = "";

        temp = "10¬∞C";
        hum = "90%";

        // Update gauges with random values
        setInterval(function () {
            gauge_temp.setValueAnimated(Math.floor(Math.random() * (45 - 35 + 1)) + 35, 100);
        }, 3000);

        setInterval(function () {
            gauge_hum.setValueAnimated(Math.floor(Math.random() * (90 - 70 + 1)) + 70, 100);
        }, 3000);

        // Voice control
        let chunks = [];
        let recorder;

        document.getElementById('record-button').onmousedown = () => {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('record-button').classList.add('recording');
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    recorder = new MediaRecorder(stream);
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = saveRecording;
                    recorder.start();
                });
        };

        document.getElementById('record-button').onmouseup = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('record-button').classList.remove('recording');
            if (recorder) {
                recorder.stop();
            }
        };

        function saveRecording() {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            chunks = [];
            sendAudioToServer(blob);
        }

        function sendAudioToServer(blob) {
            console.log('üéµ Sending audio to server, size:', blob.size);
            
            const formData = new FormData();
            formData.append('audio', blob, 'recording.wav');
        
            fetch('http://127.0.0.1:5000/transcribe', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Transcription failed: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Transcription received:', data.transcription);
                handleTranscription(data.transcription);
            })
            .catch(error => {
                console.error('‚ùå Transcription error:', error);
                const voiceStatus = document.querySelector('.voice-status');
                if (voiceStatus) {
                    voiceStatus.textContent = `Erreur transcription: ${error.message}`;
                    setTimeout(() => {
                        voiceStatus.textContent = 'Appuyez pour activer';
                    }, 3000);
                }
            });
        }

        function handleTranscription(transcription) {
            console.log('üéØ Processing transcription:', transcription);
            
            // Update voice status
            const voiceStatus = document.querySelector('.voice-status');
            if (voiceStatus) {
                voiceStatus.textContent = `Traitement: "${transcription}"`;
            }
            
            let states = get_State();
            let all_states = get_All_State();
            
            fetch('http://127.0.0.1:5000/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    text: transcription, 
                    state: states, 
                    all_state: all_states
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ü§ñ AI Response:', data);
                
                // Display assistant response if available
                if (data.assistant_response) {
                    if (voiceStatus) {
                        voiceStatus.textContent = data.assistant_response;
                        setTimeout(() => {
                            voiceStatus.textContent = 'Appuyez pour activer';
                        }, 3000);
                    }
                }
                
                executeCommands(JSON.stringify(data));
            })
            .catch(error => {
                console.error('‚ùå API Error:', error);
                if (voiceStatus) {
                    voiceStatus.textContent = `Erreur: ${error.message}`;
                    setTimeout(() => {
                        voiceStatus.textContent = 'Appuyez pour activer';
                    }, 3000);
                }
            });
        }

        function executeCommands(json) {
            const etats = JSON.parse(json);
            console.log('üéÆ Executing commands:', etats);

            // Handle assistant response (for legacy compatibility)
            if (etats['assistant_response']) {
                console.log('ü§ñ Assistant says:', etats['assistant_response']);
            }

            // Audio response handling - prioritize WebSocket, fallback to direct
            if (etats['audio'] == true || !socket.connected) {
                // Fallback to direct audio fetch if WebSocket not connected
                const audio = new Audio(`http://127.0.0.1:5000/audio`);
                audio.play().catch(err => {
                    console.log('Audio playback failed:', err);
                });
            }

            // Alarm handling
            if (etats['alarm']) {
                const alarmInput = document.getElementById("alarmTime");
                if (alarmInput) {
                    alarmInput.value = etats['alarm'];
                }
            }

            // Door controls with enhanced feedback
            var wrapper1 = document.getElementById('d1');
            if (wrapper1) {
                const shouldBeOpen = etats['door1'] === "on";
                const isCurrentlyOpen = wrapper1.classList.contains('open');
                
                if (shouldBeOpen !== isCurrentlyOpen) {
                    toggleDoors1();
                    // Visual feedback
                    wrapper1.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        wrapper1.style.transform = '';
                    }, 300);
                }
            }

            var wrapper2 = document.getElementById('d2');
            if (wrapper2) {
                const shouldBeOpen = etats['door2'] === "on";
                const isCurrentlyOpen = wrapper2.classList.contains('open');
                
                if (shouldBeOpen !== isCurrentlyOpen) {
                    toggleDoors2();
                    // Visual feedback
                    wrapper2.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        wrapper2.style.transform = '';
                    }, 300);
                }
            }

            // Device controls with enhanced visual feedback
            const deviceIds = ['salon', 'cuisine', 'chambre', 'exterieur', 'garage', 'smoke', 'presence', 'auth'];
            
            deviceIds.forEach(id => {
                if (etats.hasOwnProperty(id)) {
                    const element = document.getElementById(id);
                    const card = document.querySelector(`[data-room="${id}"]`) || 
                               document.querySelector(`#${id}`).closest('.light-card, .sensor-card');
                    
                    if (element && element.checked !== etats[id]) {
                        element.checked = etats[id];
                        
                        // Enhanced visual feedback
                        if (card) {
                            if (etats[id]) {
                                card.classList.add('active');
                                // Pulse effect for activation
                                card.style.animation = 'lightPulse 0.6s ease-out';
                            } else {
                                card.classList.remove('active');
                            }
                            
                            // Reset animation
                            setTimeout(() => {
                                card.style.animation = '';
                            }, 600);
                        }
                        
                        // Trigger change events for API calls
                        if (element.onchange) {
                            element.onchange();
                        }
                        
                        // Update status text for lights
                        const statusElement = card?.querySelector('.light-status');
                        if (statusElement) {
                            statusElement.textContent = etats[id] ? 'ALLUM√â' : '√âTEINT';
                        }
                    }
                }
            });
            
            console.log('‚úÖ Commands executed successfully');
        }

        function get_All_State() {
            const etats = {};
            const deviceIds = ['salon', 'cuisine', 'chambre', 'exterieur', 'garage', 'smoke', 'presence', 'auth'];
            
            // Get device states
            deviceIds.forEach(id => {
                const element = document.getElementById(id);
                etats[id] = element ? element.checked : false;
            });

            // Get sensor data (simulated for now)
            etats['temp'] = document.querySelector('.sensor-value')?.textContent || "22¬∞C";
            etats['hum'] = document.querySelectorAll('.sensor-value')[1]?.textContent || "65%";

            // Get door states
            const wrapper1 = document.getElementById('d1');
            etats['door1'] = wrapper1?.classList.contains('open') ? "on" : "off";

            const wrapper2 = document.getElementById('d2');
            etats['door2'] = wrapper2?.classList.contains('open') ? "on" : "off";

            // Get current time in API format: "HH:MM:SS---DDMmmYYYY"
            const now = new Date();
            const time = now.toLocaleTimeString('fr-FR', { hour12: false });
            const day = now.getDate().toString().padStart(2, '0');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            etats['time'] = `${time}---${day}${month}${year}`;

            // Convert to the string format expected by API
            const etatsArray = Object.entries(etats).map(([key, value]) => {
                const formattedValue = typeof value === 'string' ? `"${value}"` : value;
                return `"${key}": ${formattedValue}`;
            });
            
            return etatsArray.join(', ');
        }

        function get_State() {
            const etats = {};
            const ids = ['salon', 'cuisine', 'chambre', 'exterieur', 'garage'];
            
            ids.forEach(id => {
                const checkbox = document.getElementById(id);
                etats[id] = checkbox ? checkbox.checked : false;
            });

            var wrapper1 = document.getElementById('d1');
            etats['door1'] = wrapper1.classList.contains('open') ? "on" : "off";

            var wrapper2 = document.getElementById('d2');
            etats['door2'] = wrapper2.classList.contains('open') ? "on" : "off";

            let etatsJson = JSON.stringify(etats);
            return etatsJson.slice(1, -1);
        }

        // Alarm form handling
        document.getElementById('alarmForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const alarmTime = document.getElementById('alarmTime').value;
            const status = document.getElementById('status');
            status.textContent = `Alarme programm√©e pour ${alarmTime}`;
            status.style.color = 'var(--accent-color)';
            
            // Send to server if needed
            fetch('http://34.134.18.88:5000/set-alarm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'alarmTime=' + encodeURIComponent(alarmTime)
            }).catch(err => console.log('Server not available'));
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
</body>
</html>