<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelinks - Votre Maison Connectée</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <input type="checkbox" id="theme-switch" class="theme-switch-input">
        <label for="theme-switch" class="theme-switch-label">
            <i class="fas fa-sun"></i>
            <i class="fas fa-moon"></i>
        </label>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Header -->
        <header class="header-section">
            <div class="welcome-card glass-card">
                <div class="welcome-content">
                    <h1 class="welcome-title">
                        <i class="fas fa-home"></i>
                        Bonjour !
                    </h1>
                    <p class="welcome-subtitle">Homelinks - Votre Maison Connectée</p>
                    <div class="status-indicators">
                        <span class="status-dot active"></span>
                        <span class="status-text">Système actif</span>
                    </div>
                </div>
            </div>
        </header>
        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Lighting Control Section -->
                <section class="control-section">
                    <div class="section-header">
                        <i class="fas fa-lightbulb"></i>
                        <h2>Éclairage</h2>
                    </div>
                    <div class="lights-grid">
                        <div class="light-card glass-card" data-room="salon">
                            <div class="light-icon">
                                <i class="fas fa-couch"></i>
                            </div>
                            <h3>Salon</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="salon" onchange="switchLED(this)">
                                <label for="salon" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="cuisine">
                            <div class="light-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <h3>Cuisine</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="cuisine" onchange="switchLED(this)">
                                <label for="cuisine" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="chambre">
                            <div class="light-icon">
                                <i class="fas fa-bed"></i>
                            </div>
                            <h3>Chambre</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="chambre" onchange="switchLED(this)">
                                <label for="chambre" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="exterieur">
                            <div class="light-icon">
                                <i class="fas fa-tree"></i>
                            </div>
                            <h3>Extérieur</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="exterieur" onchange="switchLED(this)">
                                <label for="exterieur" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="light-card glass-card" data-room="garage">
                            <div class="light-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <h3>Garage</h3>
                            <div class="light-switch">
                                <input type="checkbox" id="garage" onchange="switchLED(this)">
                                <label for="garage" class="switch-label">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Sensors Section -->
                <section class="control-section">
                    <div class="section-header">
                        <i class="fas fa-shield-alt"></i>
                        <h2>Détecteurs Sensoriels</h2>
                    </div>
                    <div class="sensors-grid">
                        <div class="sensor-card glass-card">
                            <div class="sensor-indicator">
                                <input type="checkbox" id="presence" class="sensor-input">
                                <label for="presence" class="sensor-label">
                                    <i class="fas fa-walking"></i>
                                </label>
                            </div>
                            <h3>Détecteur de Présence</h3>
                            <span class="sensor-status">Inactif</span>
                        </div>

                        <div class="sensor-card glass-card">
                            <div class="sensor-indicator">
                                <input type="checkbox" id="smoke" class="sensor-input">
                                <label for="smoke" class="sensor-label">
                                    <i class="fas fa-fire-smoke"></i>
                                </label>
                            </div>
                            <h3>Détecteur de Fumée</h3>
                            <span class="sensor-status">Sécurisé</span>
                        </div>

                        <div class="sensor-card glass-card">
                            <div class="sensor-indicator">
                                <input type="checkbox" id="auth" class="sensor-input">
                                <label for="auth" class="sensor-label">
                                    <i class="fas fa-id-card"></i>
                                </label>
                            </div>
                            <h3>Authentification RFID</h3>
                            <span class="sensor-status">En attente</span>
                        </div>
                    </div>
                </section>

                <!-- Alarm Section -->
                <section class="control-section alarm-section">
                    <div class="section-header">
                        <i class="fas fa-alarm-clock"></i>
                        <h2>Réveil Intelligent</h2>
                    </div>
                    <div class="alarm-card glass-card">
                        <form id="alarmForm" class="alarm-form">
                            <div class="time-input-container">
                                <input type="time" id="alarmTime" class="alarm-time-input" value="10:05" required>
                                <label for="alarmTime" class="time-label">Heure du réveil</label>
                            </div>
                            <button type="submit" class="alarm-btn">
                                <i class="fas fa-clock"></i>
                                Programmer
                            </button>
                            <p id="status" class="alarm-status"></p>
                        </form>
                    </div>
                </section>
            </div>
            <!-- Right Column -->
            <div class="right-column">
                <!-- Clock and Date Widget -->
                <section class="widget-section">
                    <div class="datetime-widget glass-card">
                        <div class="clock-container">
                            <div class="analog-clock">
                                <div class="clock-face">
                                    <div class="hour-hand" id="hr"></div>
                                    <div class="minute-hand" id="mn"></div>
                                    <div class="second-hand" id="sc"></div>
                                    <div class="center-dot"></div>
                                </div>
                            </div>
                            <div class="digital-time">
                                <div class="time-display" id="digital-time"></div>
                                <div class="date-display" id="date-display">
                                    <span id="day">day</span>,
                                    <span id="daynum">00</span>
                                    <span id="month">month</span>
                                    <span id="year">0000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Climate Control -->
                <section class="widget-section">
                    <div class="section-header">
                        <i class="fas fa-thermometer-half"></i>
                        <h2>Climat</h2>
                    </div>
                    <div class="climate-grid">
                        <div class="climate-card glass-card">
                            <div class="gauge-header">
                                <i class="fas fa-temperature-high"></i>
                                <h3>Température</h3>
                            </div>
                            <div id="gauge_temp" class="gauge-container modern-gauge"></div>
                        </div>
                        <div class="climate-card glass-card">
                            <div class="gauge-header">
                                <i class="fas fa-tint"></i>
                                <h3>Humidité</h3>
                            </div>
                            <div id="gauge_hum" class="gauge-container modern-gauge"></div>
                        </div>
                    </div>
                </section>

                <!-- Security Section -->
                <section class="widget-section">
                    <div class="section-header">
                        <i class="fas fa-lock"></i>
                        <h2>Sécurité</h2>
                    </div>
                    <div class="security-grid">
                        <div class="door-card glass-card">
                            <div class="door-control" id="d1" onclick="toggleDoors1()">
                                <div class="door-wrapper">
                                    <img src="https://images.pexels.com/photos/276724/pexels-photo-276724.jpeg?cs=srgb&dl=pexels-pixabay-276724.jpg&fm=jpg" alt="Entrée" class="door-image">
                                    <div id="left-door1" class="door-panel left">
                                        <div class="door-handle"></div>
                                    </div>
                                    <div id="right-door1" class="door-panel right">
                                        <div class="door-handle"></div>
                                    </div>
                                </div>
                            </div>
                            <h3>Entrée Principale</h3>
                            <span class="door-status" id="door1-status">Fermée</span>
                        </div>

                        <div class="door-card glass-card">
                            <div class="door-control" id="d2" onclick="toggleDoors2()">
                                <div class="door-wrapper">
                                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS-gHRKbPfAPUlJjXVoO5kZOD0PCVhfWqv0Zg&s" alt="Garage" class="door-image">
                                    <div id="left-door2" class="door-panel left">
                                        <div class="door-handle"></div>
                                    </div>
                                    <div id="right-door2" class="door-panel right">
                                        <div class="door-handle"></div>
                                    </div>
                                </div>
                            </div>
                            <h3>Garage</h3>
                            <span class="door-status" id="door2-status">Fermée</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Voice Control Button -->
        <div class="voice-control">
            <button id="record-button" class="voice-btn">
                <div class="voice-icon">
                    <i class="fas fa-microphone"></i>
                </div>
                <div class="voice-waves">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            <span class="voice-hint">Appuyez et maintenez pour parler</span>
        </div>

        <!-- Loading Animation -->
        <div class="loading-overlay" id="overlay">
            <div class="loading-spinner" id="loader">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <p>Traitement en cours...</p>
            </div>
        </div>
    </div>
    
    <p id="transcript" style="display: none;"></p>
    <script type="text/javascript" src="js/gauge.js"></script>
    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('theme-switch');
        const body = document.body;

        themeToggle.addEventListener('change', () => {
            body.classList.toggle('light-theme');
            localStorage.setItem('theme', body.classList.contains('light-theme') ? 'light' : 'dark');
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            body.classList.add('light-theme');
            themeToggle.checked = true;
        }

        // Digital Time Display
        function updateDigitalTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('digital-time').textContent = timeString;
        }

        // Analog Clock
        function updateAnalogClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const hourDeg = (hours % 12) * 30 + minutes * 0.5;
            const minuteDeg = minutes * 6;
            const secondDeg = seconds * 6;

            document.getElementById('hr').style.transform = `rotate(${hourDeg}deg)`;
            document.getElementById('mn').style.transform = `rotate(${minuteDeg}deg)`;
            document.getElementById('sc').style.transform = `rotate(${secondDeg}deg)`;
        }

        // Update time displays
        function updateTime() {
            updateDigitalTime();
            updateAnalogClock();
        }

        setInterval(updateTime, 1000);
        updateTime(); // Initial call

        // Date Display
        function updateDate() {
            const today = new Date();
            const dayName = today.getDay();
            const dayNum = today.getDate();
            const month = today.getMonth();
            const year = today.getFullYear();

            const months = [
                "Janvier", "Février", "Mars", "Avril", "Mai", "Juin",
                "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"
            ];
            const dayWeek = [
                "Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"
            ];

            document.getElementById('day').textContent = dayWeek[dayName];
            document.getElementById('daynum').textContent = dayNum.toString().padStart(2, '0');
            document.getElementById('month').textContent = months[month];
            document.getElementById('year').textContent = year;
        }

        updateDate();

        // Enhanced Door Controls
        function toggleDoors1() {
            const door = document.getElementById('d1');
            const status = document.getElementById('door1-status');
            door.classList.toggle('open');
            status.textContent = door.classList.contains('open') ? 'Ouverte' : 'Fermée';
            status.className = door.classList.contains('open') ? 'door-status open' : 'door-status';
        }

        function toggleDoors2() {
            const door = document.getElementById('d2');
            const status = document.getElementById('door2-status');
            door.classList.toggle('open');
            status.textContent = door.classList.contains('open') ? 'Ouverte' : 'Fermée';
            status.className = door.classList.contains('open') ? 'door-status open' : 'door-status';
        }

        // Enhanced Switch LED function
        function switchLED(checkbox) {
            const card = checkbox.closest('.light-card');
            const room = card.dataset.room;
            
            if (checkbox.checked) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }

            // Call your existing API
            var state = checkbox.checked ? 'on' : 'off';
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(`${room} light ${state}`);
                }
            };
            xhttp.open("GET", "http://127.0.0.1:5500/" + checkbox.id + "/" + state, true);
            xhttp.send();
        }

        // Enhanced Sensor Status Updates
        function updateSensorStatus(sensorId, active) {
            const sensorCard = document.querySelector(`#${sensorId}`).closest('.sensor-card');
            const statusText = sensorCard.querySelector('.sensor-status');
            
            if (active) {
                sensorCard.classList.add('active');
                document.getElementById(sensorId).checked = true;
                
                switch(sensorId) {
                    case 'presence':
                        statusText.textContent = 'Présence détectée';
                        break;
                    case 'smoke':
                        statusText.textContent = 'Fumée détectée';
                        break;
                    case 'auth':
                        statusText.textContent = 'Authentifié';
                        break;
                }
            } else {
                sensorCard.classList.remove('active');
                document.getElementById(sensorId).checked = false;
                
                switch(sensorId) {
                    case 'presence':
                        statusText.textContent = 'Inactif';
                        break;
                    case 'smoke':
                        statusText.textContent = 'Sécurisé';
                        break;
                    case 'auth':
                        statusText.textContent = 'En attente';
                        break;
                }
            }
        }

        // Initialize gauges
        var gauge_temp = Gauge(
            document.getElementById("gauge_temp"), {
                label: function(value) {
                    return value + "°C";
                },
                max: 100,
                value: 0,
            }
        );

        var gauge_hum = Gauge(
            document.getElementById("gauge_hum"), {
                label: function(value) {
                    return value + "%";
                },
                max: 100,
                value: 0
            }
        );

        let temp = "";
        let hum = "";

        temp = "10°C";
        hum = "90%";

        // Update gauges with random values
        setInterval(function () {
            gauge_temp.setValueAnimated(Math.floor(Math.random() * (45 - 35 + 1)) + 35, 100);
        }, 3000);

        setInterval(function () {
            gauge_hum.setValueAnimated(Math.floor(Math.random() * (90 - 70 + 1)) + 70, 100);
        }, 3000);

        // Voice control
        let chunks = [];
        let recorder;

        document.getElementById('record-button').onmousedown = () => {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('record-button').classList.add('recording');
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    recorder = new MediaRecorder(stream);
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = saveRecording;
                    recorder.start();
                });
        };

        document.getElementById('record-button').onmouseup = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('record-button').classList.remove('recording');
            if (recorder) {
                recorder.stop();
            }
        };

        function saveRecording() {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            chunks = [];
            sendAudioToServer(blob);
        }

        function sendAudioToServer(blob) {
            const formData = new FormData();
            formData.append('audio', blob);
        
            fetch('http://127.0.0.1:5000/transcribe', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => handleTranscription(data.transcription));
        }

        function handleTranscription(transcription) {
            let states = get_State();
            let all_states = get_All_State();
            fetch('http://127.0.0.1:5000/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: transcription, state: states, all_state: all_states})
            })
            .then(response => response.json())
            .then(data => executeCommands(data.commands));
        }

        function executeCommands(json) {
            const etats = JSON.parse(json);

            if (etats['audio'] == true) {
                const audio = new Audio(`http://127.0.0.1:5000/audio`);
                audio.play();
            }

            if (etats['alarm']) {
                document.getElementById("alarmTime").value = etats['alarm'];
            }

            var wrapper1 = document.getElementById('d1');
            if ((etats['door1']==="on" && wrapper1.classList.contains('open')) || (etats['door1']==="off" && !wrapper1.classList.contains('open'))){
                console.log(" ")
            } else {
                toggleDoors1();
            }

            var wrapper2 = document.getElementById('d2');
            if ((etats['door2']==="on" && wrapper2.classList.contains('open')) || (etats['door2']==="off" && !wrapper2.classList.contains('open'))){
                console.log(" ")
            } else {
                toggleDoors2();
            }

            const entries = Object.entries(etats);
            for (let i = 0; i < entries.length ; i++) {
                const [id, checked] = entries[i];
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = checked;
                    // Trigger visual updates
                    if (checkbox.onchange) {
                        checkbox.onchange();
                    }
                }
            }
        }

        function get_All_State() {
            const etats = {};
            const ids = ['salon', 'cuisine', 'chambre', 'exterieur', 'garage', 'smoke', 'presence', 'auth'];
            
            ids.forEach(id => {
                const checkbox = document.getElementById(id);
                etats[id] = checkbox ? checkbox.checked : false;
            });

            etats['temp'] = temp;
            etats['hum'] = hum;

            var wrapper1 = document.getElementById('d1');
            etats['door1'] = wrapper1.classList.contains('open') ? "on" : "off";

            var wrapper2 = document.getElementById('d2');
            etats['door2'] = wrapper2.classList.contains('open') ? "on" : "off";

            etats['time'] = document.getElementById('digital-time').textContent + " " + 
                           document.getElementById('date-display').textContent;

            let etatsJson = JSON.stringify(etats);
            return etatsJson.slice(1, -1);
        }

        function get_State() {
            const etats = {};
            const ids = ['salon', 'cuisine', 'chambre', 'exterieur', 'garage'];
            
            ids.forEach(id => {
                const checkbox = document.getElementById(id);
                etats[id] = checkbox ? checkbox.checked : false;
            });

            var wrapper1 = document.getElementById('d1');
            etats['door1'] = wrapper1.classList.contains('open') ? "on" : "off";

            var wrapper2 = document.getElementById('d2');
            etats['door2'] = wrapper2.classList.contains('open') ? "on" : "off";

            let etatsJson = JSON.stringify(etats);
            return etatsJson.slice(1, -1);
        }

        // Alarm form handling
        document.getElementById('alarmForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const alarmTime = document.getElementById('alarmTime').value;
            const status = document.getElementById('status');
            status.textContent = `Alarme programmée pour ${alarmTime}`;
            status.style.color = 'var(--accent-color)';
            
            // Send to server if needed
            fetch('http://127.0.0.1:5500/set-alarm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'alarmTime=' + encodeURIComponent(alarmTime)
            }).catch(err => console.log('Server not available'));
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
</body>
</html>